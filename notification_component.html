<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .notification-item {
            background: white;
            border: 2px solid #1f77b4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-item.warning {
            border-color: #ff9800;
            background: #fff3e0;
        }
        
        .notification-item.urgent {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #1f77b4;
        }
        
        .notification-body {
            color: #333;
            margin-bottom: 5px;
        }
        
        .notification-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        .close-btn {
            float: right;
            cursor: pointer;
            font-size: 1.2rem;
            color: #999;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .permission-banner {
            background: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .permission-banner:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="notificationContainer" class="notification-container"></div>
    
    <script>
        // Global state
        let notifiedEvents = new Set();
        let checkInterval = null;
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const banner = document.createElement('div');
                banner.className = 'permission-banner';
                banner.innerHTML = 'üîî Nh·∫•n ƒë·ªÉ cho ph√©p th√¥ng b√°o nh·∫Øc nh·ªü s·ª± ki·ªán';
                banner.onclick = function() {
                    Notification.requestPermission().then(function(permission) {
                        if (permission === 'granted') {
                            showInAppNotification('‚úÖ ƒê√£ b·∫≠t th√¥ng b√°o', 'B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c nh·∫Øc nh·ªü v·ªÅ c√°c s·ª± ki·ªán s·∫Øp t·ªõi!', 'success');
                            banner.remove();
                        }
                    });
                };
                document.getElementById('notificationContainer').appendChild(banner);
            }
        }
        
        // Show in-app notification
        function showInAppNotification(title, body, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notif = document.createElement('div');
            notif.className = 'notification-item';
            
            if (type === 'warning') notif.classList.add('warning');
            if (type === 'urgent') notif.classList.add('urgent');
            
            notif.innerHTML = `
                <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>
                <div class="notification-title">${title}</div>
                <div class="notification-body">${body}</div>
                <div class="notification-time">${new Date().toLocaleTimeString('vi-VN')}</div>
            `;
            
            container.appendChild(notif);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (notif.parentElement) {
                    notif.style.opacity = '0';
                    setTimeout(() => notif.remove(), 300);
                }
            }, 10000);
        }
        
        // Check upcoming events
        function checkUpcomingEvents() {
            const events = window.upcomingEvents || [];
            const now = new Date();
            
            events.forEach(event => {
                if (notifiedEvents.has(event.id)) return;
                
                const eventTime = new Date(event.start_time);
                const reminderTime = new Date(eventTime.getTime() - (event.reminder_minutes || 15) * 60000);
                const timeDiff = eventTime.getTime() - now.getTime();
                const minutesUntil = Math.floor(timeDiff / 60000);
                
                // Check if it's time to remind
                if (now >= reminderTime && now < eventTime) {
                    const title = 'üìÖ Nh·∫Øc nh·ªü s·ª± ki·ªán';
                    const locationStr = event.location ? ` t·∫°i ${event.location}` : '';
                    const body = `${event.name} s·∫Ω b·∫Øt ƒë·∫ßu l√∫c ${eventTime.toLocaleTimeString('vi-VN')}${locationStr}`;
                    
                    // Browser notification
                    if (Notification.permission === 'granted') {
                        const notification = new Notification(title, {
                            body: body,
                            icon: 'üìÖ',
                            badge: 'üìÖ',
                            tag: event.id,
                            requireInteraction: true
                        });
                        
                        notification.onclick = function() {
                            window.focus();
                            this.close();
                        };
                    }
                    
                    // In-app notification
                    const type = minutesUntil <= 5 ? 'urgent' : minutesUntil <= 15 ? 'warning' : 'info';
                    showInAppNotification(title, body, type);
                    
                    // Mark as notified
                    notifiedEvents.add(event.id);
                }
            });
        }
        
        // Initialize
        function initNotifications() {
            requestNotificationPermission();
            
            // Check immediately
            checkUpcomingEvents();
            
            // Check every 30 seconds
            if (checkInterval) clearInterval(checkInterval);
            checkInterval = setInterval(checkUpcomingEvents, 30000);
        }
        
        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNotifications);
        } else {
            initNotifications();
        }
        
        // Re-check when events update
        window.addEventListener('upcomingEventsUpdated', function() {
            console.log('Events updated, rechecking...');
            checkUpcomingEvents();
        });
    </script>
</body>
</html>
